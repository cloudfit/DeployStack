{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Transit VPC: This template creates a dedicated transit VPC with Palo Alto for routing traffic. ***NOTE*** You must first subscribe to the appropriate Palo Alto marketplace BYOL or License Included AMI from the AWS Marketplace before you launch this template.",
  "Parameters":{
    "UserName": {
      "Description" : "Palo Alto Login User Name",
      "Type" : "String"
    },
    "Password": {
      "Description" : "Palo Alto Login User Password",
       "Type" : "String"
    },
    "paBootstrapBucketName" : {
      "Description" : "Existing S3 bucket which is having PA-Bootstrap configuration",
      "Type" : "String"
    },
    "KeyName":{
      "Description":"Name of an existing EC2 KeyPair to enable SSH access to the instances",
      "Type":"AWS::EC2::KeyPair::KeyName",
      "Default":"Lab"
    },
    "TerminationProtection":{
      "Description":"Enable termination protection on the PAVM EC2 instances to avoid accidential PAVM termination?",
      "Type":"String",
      "Default":"Yes",
      "AllowedValues":[
        "Yes",
        "No"
      ]
    },
    "PreferredPathTag":{
      "Description":"Tag to use to configure a preferred PA VPN endpoint to control traffic flow through the Transit VPC (e.g. when integrating with CPE).",
      "Type":"String",
      "Default":"transitvpc:preferred-path"
    },
    "BgpAsn":{
      "Description":"BGP ASN to use for Transit VPC.",
      "Type":"String",
      "Default":"64512"
    },
    "VpcCidr":{
      "Description":"CIDR block for Transit VPC.",
      "Type":"String",
      "Default":"200.0.0.0/16"
    },
    "PubSubnet11":{
      "Description":"Address range for Transit VPC subnet to be created in AZ1.",
      "Type":"String",
      "Default":"200.0.254.0/24"
    },
    "PubSubnet12":{
      "Description":"Address range for Transit VPC subnet to be created in AZ1.",
      "Type":"String",
      "Default":"200.0.1.0/24"
    },
    "PubSubnet21":{
      "Description":"Address range for Transit VPC subnet to be created in AZ2.",
      "Type":"String",
      "Default":"200.0.253.0/24"
    },
    "PubSubnet22":{
      "Description":"Address range for Transit VPC subnet to be created in AZ2.",
      "Type":"String",
      "Default":"200.0.2.0/24"
    },
    "PAVMType":{
      "Description":"Maximum network througput required for PA instances.",
      "Type":"String",
      "Default":"m4.xlarge",
      "AllowedValues":[
        "m4.xlarge"
      ]
    },
    "LicenseModel":{
      "Description":"Choose between BYOL (Bring Your Own License) and License Included license models. Remember to first subscribe the the appropriate Marketplace AMI!",
      "Type":"String",
      "Default":"LicenseIncluded",
      "AllowedValues":[
        "LicenseIncluded",
        "BYOL"
      ]
    },
	  "AccountId":{
      "Description":"Another AWS Account ID to authorize access to VPN Config S3 bucket (for example bucket and KMS key policies).",
      "Type":"String",
      "Default":""
    }		
  },
  "Conditions":{
    "AuthorizeAnotherAccount":{
      "Fn::Not":[
        {
          "Fn::Equals":[
            {
              "Ref":"AccountId"
            },
            ""
          ]
        }
      ]
    },
    "EnableTerm":{
      "Fn::Equals":[
        {
          "Ref":"TerminationProtection"
        },
        "Yes"
      ]
    }
  },
  "Metadata":{
    "AWS::CloudFormation::Interface":{
      "ParameterGroups":[
        {
          "Label":{
            "default":"PA VM Configuration"
          },
          "Parameters":[
            "PAVMType",
            "KeyName",
            "LicenseModel",
            "TerminationProtection",
			"paBootstrapBucketName",
			"UserName",
			"Password"
          ]
        },
        {
          "Label":{
            "default":"AWS Service Configuration"
          },
          "Parameters":[
            "AccountId"
          ]
        },
        {
          "Label":{
            "default":"Network Configuration"
          },
          "Parameters":[
            "VpcCidr",
            "PubSubnet11",
            "PubSubnet12",
            "PubSubnet21",
            "PubSubnet22",
            "BgpAsn",
            "PreferredPathTag"
          ]
        }
     ],
      "ParameterLabels":{
        "BgpAsn":{
          "default":"Transit VPC BGP ASN"
        },
        "PreferredPathTag":{
          "default":"Preferred VPN Endpoint Tag Name"
        },
        "VpcCidr":{
          "default":"Transit VPC CIDR Block"
        },
        "PubSubnet11":{
          "default":"PAVM1- 1st Subnet Network"
        },
        "PubSubnet12":{
          "default":"PAVM1- 2nd Subnet Network"
        },
        "PubSubnet21":{
          "default":"PAVM2- 1st Subnet Network"
        },
        "PubSubnet22":{
          "default":"PAVM2- 2nd Subnet Network"
        },
        "PAVMType":{
          "default":"PAVM Throughput Requirements"
        },
        "KeyName":{
          "default":"SSH Key to access PAVM"
        },
        "LicenseModel":{
          "default":"License Model"
        },
        "TerminationProtection":{
          "default":"Enable Termination Protection"
        },
		"paBootstrapBucketName":{
          "default":"paloalto Bootstrap Bucket Name"
        },
		"UserName":{
          "default":"paloalto UserName"
        },
		"Password":{
          "default":"paloalto Password"
        },
		"AccountId":{
          "default":"Additional AWS Account ID (Optional)"
        }
      }
    }
  },
  "Mappings":{
    "PaloAltoPAVMAMI":{
      "ap-south-1":{
        "BYOL":"ami-0268196d",
        "LicenseIncluded":"ami-0368196c"
      },
      "eu-west-2":{
        "BYOL":"ami-a74e5bc3",
        "LicenseIncluded":"ami-5c4f5a38"
      },
      "eu-west-1":{
        "BYOL":"ami-32fca754",
        "LicenseIncluded":"ami-1fb1ff66"
      },
      "ap-northeast-2":{
        "BYOL":"ami-925e8ffc",
        "LicenseIncluded":"ami-19409177"
      },
      "ap-northeast-1":{
        "BYOL":"ami-a8bef8cf",
        "LicenseIncluded":"ami-56bff931"
      },
      "sa-east-1":{
        "BYOL":"ami-feb6d292",
        "LicenseIncluded":"ami-20b5d14c"
      },
      "us-central-1":{
        "BYOL":"ami-c4c37ea0",
        "LicenseIncluded":"ami-ebc17c8f"
      },
      "ap-southeast-1":{
        "BYOL":"ami-55bb0f36",
        "LicenseIncluded":"ami-a5bb0fc6"
      },
      "ap-southeast-2":{
        "BYOL":"ami-2f3e384c",
        "LicenseIncluded":"ami-cc3335af"
      },
      "eu-central-1":{
        "BYOL":"ami-bb3af3d4",
        "LicenseIncluded":"ami-e43df48b"
      },
      "us-east-1":{
        "BYOL":"ami-f22cd7e4",
        "LicenseIncluded":"ami-4222d954"
      },
      "us-east-2":{
        "BYOL":"ami-360c2953",
        "LicenseIncluded":"ami-0e0d286b"
      },
      "us-west-1":{
        "BYOL":"ami-a1a5f8c1",
        "LicenseIncluded":"ami-59a3fe39"
      },
      "us-west-2":{
        "BYOL":"ami-ca14afaa",
        "LicenseIncluded":"ami-9c15aefc"
      }
    },
    "PAVMInstance":{
      "m4.xlarge":{
        "Type":"m4.xlarge",
        "Bandwidth":"500000"
      }
    }
  },
  "Resources":{
    "paBootstrapBucketAccessRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
            "AssumeRolePolicyDocument": {
               "Version": "2012-10-17",
               "Statement": [ { "Effect": "Allow", "Principal": { "Service": [ "ec2.amazonaws.com" ] }, "Action": [ "sts:AssumeRole" ] } ]
            },
      "Path": "/",
          "Policies": [
            {
                "PolicyName": "paBootstrapBucketAccessReadPolicy",
                "PolicyDocument": {
                "Version": "2012-10-17",
                    "Statement": [
                    {
                       "Resource": [
                        { "Fn::Join": [ "", [ "arn:aws:s3:::",{ "Ref" : "paBootstrapBucketName" } ] ] },
                        { "Fn::Join": [ "", [ "arn:aws:s3:::",{ "Ref" : "paBootstrapBucketName" },"/*" ] ] }
                       ],
                   "Action": [ "s3:List*", "s3:Get*" ],
                   "Effect": "Allow"
                        }
                   ]
                }
               }
            ]
        }
    },
    "paGroupInstanceProfile": {
        "Type": "AWS::IAM::InstanceProfile",
        "Properties": {
        "Path": "/",
        "Roles": [ { "Ref": "paBootstrapBucketAccessRole" } ]
        }
    },
    "VPNConfigS3Bucket":{
      "Type":"AWS::S3::Bucket"
    },
    "VPNConfigBucketPolicy":{
      "Type":"AWS::S3::BucketPolicy",
      "Properties":{
        "Bucket":{
          "Ref":"VPNConfigS3Bucket"
        },
        "PolicyDocument":{
          "Statement":[
            {
              "Sid":"DenyUnEncryptedObjectUploads",
              "Effect":"Deny",
              "Principal":"*",
              "Action":"s3:PutObject",
              "Resource":{
                "Fn::Join":[
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Ref":"VPNConfigS3Bucket"
                    },
                    "/",
                    "*"
                  ]
                ]
              },
              "Condition":{
                "StringNotEquals":{
                  "s3:x-amz-server-side-encryption":"aws:kms"
                }
              }
            },
            {
              "Action":[
                "s3:GetObject",
                "s3:PutObject",
                "s3:PutObjectAcl"
              ],
              "Effect":"Allow",
              "Resource":{
                "Fn::Join":[
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Ref":"VPNConfigS3Bucket"
                    },
                    "/",
                    "*"
                  ]
                ]
              },
              "Principal":{
                "AWS":[
                  {
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:iam::",
                        {
                          "Fn::If":[
                            "AuthorizeAnotherAccount",
                            {
                              "Ref":"AccountId"
                            },
                            {
                              "Ref":"AWS::AccountId"
                            }
                          ]
                        },
                        ":root"
                      ]
                    ]
                  }
                ]
              }
            }
          ]
        }
      }
    },
    "TransitVPC":{
      "Type":"AWS::EC2::VPC",
      "Properties":{
        "CidrBlock":{
          "Ref":"VpcCidr"
        },
        "Tags":[
          {
            "Key":"Name",
            "Value":"Transit VPC"
          }
        ]
      }
    },
    "VPCPubSub11":{
      "Type":"AWS::EC2::Subnet",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "CidrBlock":{
          "Ref":"PubSubnet11"
        },
        "AvailabilityZone":{
          "Fn::Select":[
            "0",
            {
              "Fn::GetAZs":""
            }
          ]
        },
        "Tags":[
          {
            "Key":"Network",
            "Value":"Public"
          },
          {
            "Key":"Name",
            "Value":"Transit VPC Subnet1"
          }
        ]
      }
    },
    "VPCPubSub12":{
      "Type":"AWS::EC2::Subnet",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "CidrBlock":{
          "Ref":"PubSubnet12"
        },
        "AvailabilityZone":{
          "Fn::Select":[
            "0",
            {
              "Fn::GetAZs":""
            }
          ]
        },
        "Tags":[
          {
            "Key":"Network",
            "Value":"Public"
          },
          {
            "Key":"Name",
            "Value":"Transit VPC Subnet1"
          }
        ]
      }
    },
    "VPCPubSub21":{
      "Type":"AWS::EC2::Subnet",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "CidrBlock":{
          "Ref":"PubSubnet21"
        },
        "AvailabilityZone":{
          "Fn::Select":[
            "1",
            {
              "Fn::GetAZs":""
            }
          ]
        },
        "Tags":[
          {
            "Key":"Network",
            "Value":"Public"
          },
          {
            "Key":"Name",
            "Value":"Transit VPC Subnet2"
          }
        ]
      }
    },
    "VPCPubSub22":{
      "Type":"AWS::EC2::Subnet",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "CidrBlock":{
          "Ref":"PubSubnet22"
        },
        "AvailabilityZone":{
          "Fn::Select":[
            "1",
            {
              "Fn::GetAZs":""
            }
          ]
        },
        "Tags":[
          {
            "Key":"Network",
            "Value":"Public"
          },
          {
            "Key":"Name",
            "Value":"Transit VPC Subnet1"
          }
        ]
      }
    },
    "IGW":{
      "Type":"AWS::EC2::InternetGateway",
      "Properties":{
        "Tags":[
          {
            "Key":"Name",
            "Value":"Transit VPC IGW"
          }
        ]
      }
    },
    "IGWToInternet":{
      "Type":"AWS::EC2::VPCGatewayAttachment",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "InternetGatewayId":{
          "Ref":"IGW"
        }
      }
    },
    "VPCRouteTable":{
      "Type":"AWS::EC2::RouteTable",
      "Properties":{
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "Tags":[
          {
            "Key":"Network",
            "Value":"Public"
          },
          {
            "Key":"Name",
            "Value":"Transit VPC"
          }
        ]
      }
    },
    "VPCPublicRoute":{
      "Type":"AWS::EC2::Route",
      "Properties":{
        "RouteTableId":{
          "Ref":"VPCRouteTable"
        },
        "DestinationCidrBlock":"0.0.0.0/0",
        "GatewayId":{
          "Ref":"IGW"
        }
      }
    },
    "S3Endpoint":{
      "Type":"AWS::EC2::VPCEndpoint",
      "Properties":{
        "PolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":"*",
              "Action":[
                "s3:*"
              ],
              "Resource":[
                "*"
              ]
            }
          ]
        },
        "RouteTableIds":[
          {
            "Ref":"VPCRouteTable"
          }
        ],
        "ServiceName":{
          "Fn::Join":[
            "",
            [
              "com.amazonaws.",
              {
                "Ref":"AWS::Region"
              },
              ".s3"
            ]
          ]
        },
        "VpcId":{
          "Ref":"TransitVPC"
        }
      }
    },
    "VPCPubSubnetRouteTableAssociation1":{
      "Type":"AWS::EC2::SubnetRouteTableAssociation",
      "Properties":{
        "SubnetId":{
          "Ref":"VPCPubSub11"
        },
        "RouteTableId":{
          "Ref":"VPCRouteTable"
        }
      }
    },
    "VPCPubSubnetRouteTableAssociation2":{
      "Type":"AWS::EC2::SubnetRouteTableAssociation",
      "Properties":{
        "SubnetId":{
          "Ref":"VPCPubSub12"
        },
        "RouteTableId":{
          "Ref":"VPCRouteTable"
        }
      }
    },
    "VPCPubSubnetRouteTableAssociation3":{
      "Type":"AWS::EC2::SubnetRouteTableAssociation",
      "Properties":{
        "SubnetId":{
          "Ref":"VPCPubSub21"
        },
        "RouteTableId":{
          "Ref":"VPCRouteTable"
        }
      }
    },
    "VPCPubSubnetRouteTableAssociation4":{
      "Type":"AWS::EC2::SubnetRouteTableAssociation",
      "Properties":{
        "SubnetId":{
          "Ref":"VPCPubSub22"
        },
        "RouteTableId":{
          "Ref":"VPCRouteTable"
        }
      }
    },
    "PAVMEip11":{
      "Type":"AWS::EC2::EIP",
      "Properties":{
        "Domain":"vpc"
      }
    },
    "PAVMEip12":{
      "Type":"AWS::EC2::EIP",
      "Properties":{
        "Domain":"vpc"
      }
    },
    "PAVMEip21":{
      "Type":"AWS::EC2::EIP",
      "Properties":{
        "Domain":"vpc"
      }
    },
    "PAVMEip22":{
      "Type":"AWS::EC2::EIP",
      "Properties":{
        "Domain":"vpc"
      }
    },
    "AssociateEIP11":{
      "Type":"AWS::EC2::EIPAssociation",
      "Properties":{
        "AllocationId":{
          "Fn::GetAtt":[
            "PAVMEip11",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId":{
          "Ref":"PAVMInterface11"
        }
      }
    },
    "AssociateEIP12":{
      "Type":"AWS::EC2::EIPAssociation",
      "Properties":{
        "AllocationId":{
          "Fn::GetAtt":[
            "PAVMEip12",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId":{
          "Ref":"PAVMInterface12"
        }
      }
    },
    "AssociateEIP21":{
      "Type":"AWS::EC2::EIPAssociation",
      "Properties":{
        "AllocationId":{
          "Fn::GetAtt":[
            "PAVMEip21",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId":{
          "Ref":"PAVMInterface21"
        }
      }
    },
    "AssociateEIP22":{
      "Type":"AWS::EC2::EIPAssociation",
      "Properties":{
        "AllocationId":{
          "Fn::GetAtt":[
            "PAVMEip22",
            "AllocationId"
          ]
        },
        "NetworkInterfaceId":{
          "Ref":"PAVMInterface22"
        }
      }
    },
    "PAVMInterface11":{
      "Type":"AWS::EC2::NetworkInterface",
      "Properties":{
        "Description":"PAVMRevenueInterface1",
        "SourceDestCheck":"false",
        "GroupSet":[
          {
            "Ref":"PAVMSecurityGroup"
          }
        ],
        "SubnetId":{
          "Ref":"VPCPubSub11"
        }
      }
    },
    "PAVMInterface12":{
      "Type":"AWS::EC2::NetworkInterface",
      "Properties":{
        "Description":"PAVMRevenueInterface1",
        "SourceDestCheck":"false",
        "GroupSet":[
          {
            "Ref":"PAVMSecurityGroup"
          }
        ],
        "SubnetId":{
          "Ref":"VPCPubSub12"
        }
      }
    },
    "PAVMInterface21":{
      "Type":"AWS::EC2::NetworkInterface",
      "Properties":{
        "Description":"PAVMRevenueInterface1",
        "SourceDestCheck":"false",
        "GroupSet":[
          {
            "Ref":"PAVMSecurityGroup"
          }
        ],
        "SubnetId":{
          "Ref":"VPCPubSub21"
        }
      }
    },
    "PAVMInterface22":{
      "Type":"AWS::EC2::NetworkInterface",
      "Properties":{
        "Description":"PAVMRevenueInterface1",
        "SourceDestCheck":"false",
        "GroupSet":[
          {
            "Ref":"PAVMSecurityGroup"
          }
        ],
        "SubnetId":{
          "Ref":"VPCPubSub22"
        }
      }
    },
    "VpcPAVM1":{
      "Type":"AWS::EC2::Instance",
      "Metadata":{
        "Comment1":"Launch PAVM1"
      },
      "Properties":{
        "InstanceType":{
          "Fn::FindInMap":[
            "PAVMInstance",
            {
              "Ref":"PAVMType"
            },
            "Type"
          ]
        },
        "KeyName":{
          "Ref":"KeyName"
        },
        "DisableApiTermination":{
          "Fn::If":[
            "EnableTerm",
            true,
            false
          ]
        },
        "ImageId":{
          "Fn::FindInMap":[
            "PaloAltoPAVMAMI",
            {
              "Ref":"AWS::Region"
            },
            {
              "Ref":"LicenseModel"
            }
          ]
        },
        "NetworkInterfaces":[
          {
            "NetworkInterfaceId":{
              "Ref":"PAVMInterface11"
            },
            "DeviceIndex":"0"
          },
          {
            "NetworkInterfaceId":{
              "Ref":"PAVMInterface12"
            },
            "DeviceIndex":"1"
          }
        ],
		"IamInstanceProfile" : { "Ref" : "paGroupInstanceProfile" },
		"UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
             "vmseries-bootstrap-aws-s3bucket=",{"Ref":"paBootstrapBucketName"}
            ]]}},
        "Tags":[
          {
            "Key":"Name",
            "Value":"Transit VPC PAVM1"
          }
        ]
      },
      "DependsOn":"IGW"
    },
    "VpcPAVM2":{
      "Type":"AWS::EC2::Instance",
      "Metadata":{
        "Comment1":"Launch PAVM2"
      },
      "Properties":{
        "InstanceType":{
          "Fn::FindInMap":[
            "PAVMInstance",
            {
              "Ref":"PAVMType"
            },
            "Type"
          ]
        },
        "KeyName":{
          "Ref":"KeyName"
        },
        "DisableApiTermination":{
          "Fn::If":[
            "EnableTerm",
            true,
            false
          ]
        },
        "ImageId":{
          "Fn::FindInMap":[
            "PaloAltoPAVMAMI",
            {
              "Ref":"AWS::Region"
            },
            {
              "Ref":"LicenseModel"
            }
          ]
        },
        "NetworkInterfaces":[
          {
            "NetworkInterfaceId":{
              "Ref":"PAVMInterface21"
            },
            "DeviceIndex":"0"
          },
          {
            "NetworkInterfaceId":{
              "Ref":"PAVMInterface22"
            },
            "DeviceIndex":"1"
          }
        ],
		"IamInstanceProfile" : { "Ref" : "paGroupInstanceProfile" },
		"UserData"       : { "Fn::Base64" : { "Fn::Join" : ["", [
             "vmseries-bootstrap-aws-s3bucket=",{"Ref":"paBootstrapBucketName"}
            ]]}},
        "Tags":[
          {
            "Key":"Name",
            "Value":"Transit VPC PAVM2"
          }
        ]
      },
      "DependsOn":"IGW"
    },
    "PAVMSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"PAVM Security Group Rules",
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "SecurityGroupIngress":[
          {
            "IpProtocol":"-1",
            "FromPort":"22",
            "ToPort":"22",
            "SourceSecurityGroupId":{
              "Ref":"PaloAltoConfigSecurityGroup"
            }
          }
        ],
        "SecurityGroupEgress":[
          {
            "IpProtocol":"-1",
            "FromPort":"0",
            "ToPort":"65535",
            "CidrIp":"0.0.0.0/0"
          }
        ]
      }
    },
    "PaloAltoConfigSecurityGroup":{
      "Type":"AWS::EC2::SecurityGroup",
      "Properties":{
        "GroupDescription":"Transit VPC Automation Security Group Rules",
        "VpcId":{
          "Ref":"TransitVPC"
        },
        "SecurityGroupEgress":[
          {
            "IpProtocol":"-1",
            "FromPort":"443",
            "ToPort":"443",
            "CidrIp":"0.0.0.0/0"
          }
        ]
      }
    },
    "SSHtoPAVM":{
      "Type":"AWS::EC2::SecurityGroupEgress",
      "Properties":{
        "IpProtocol":"tcp",
        "FromPort":"22",
        "ToPort":"22",
        "DestinationSecurityGroupId":{
          "Fn::GetAtt":[
            "PAVMSecurityGroup",
            "GroupId"
          ]
        },
        "GroupId":{
          "Fn::GetAtt":[
            "PaloAltoConfigSecurityGroup",
            "GroupId"
          ]
        }
      }
    },
    "PAVM1RecoveryAlarm":{
      "Type":"AWS::CloudWatch::Alarm",
      "Properties":{
        "AlarmDescription":"Trigger a recovery when PAVM1 instance status check fails for 15 consecutive minutes.",
        "Namespace":"AWS/EC2",
        "MetricName":"StatusCheckFailed_System",
        "Statistic":"Minimum",
        "Period":"60",
        "EvaluationPeriods":"35",
        "ComparisonOperator":"GreaterThanThreshold",
        "Threshold":"0",
        "AlarmActions":[
          {
            "Fn::Join":[
              "",
              [
                "arn:aws:automate:",
                {
                  "Ref":"AWS::Region"
                },
                ":ec2:recover"
              ]
            ]
          }
        ],
        "Dimensions":[
          {
            "Name":"InstanceId",
            "Value":{
              "Ref":"VpcPAVM1"
            }
          }
        ]
      }
    },
    "PAVM2RecoveryAlarm":{
      "Type":"AWS::CloudWatch::Alarm",
      "Properties":{
        "AlarmDescription":"Trigger a recovery when PAVM2 instance status check fails for 15 consecutive minutes.",
        "Namespace":"AWS/EC2",
        "MetricName":"StatusCheckFailed_System",
        "Statistic":"Minimum",
        "Period":"60",
        "EvaluationPeriods":"35",
        "ComparisonOperator":"GreaterThanThreshold",
        "Threshold":"0",
        "AlarmActions":[
          {
            "Fn::Join":[
              "",
              [
                "arn:aws:automate:",
                {
                  "Ref":"AWS::Region"
                },
                ":ec2:recover"
              ]
            ]
          }
        ],
        "Dimensions":[
          {
            "Name":"InstanceId",
            "Value":{
              "Ref":"VpcPAVM2"
            }
          }
        ]
      }
    }
  },
  "Outputs":{
    "PAVM1":{
      "Description":"IP Address for PAVM1",
      "Value":{
        "Fn::GetAtt":[
          "VpcPAVM1",
          "PublicIp"
        ]
      }
    },
    "PAVM2":{
      "Description":"IP Address for PAVM2",
      "Value":{
        "Fn::GetAtt":[
          "VpcPAVM2",
          "PublicIp"
        ]
      }
    },
    "ConfigS3Bucket":{
      "Description":"S3 bucket for storing VPN configuration information.",
      "Value":{
        "Ref":"VPNConfigS3Bucket"
      }
    },
    "PreferredPathTagName":{
      "Description":"Tag used to identify the spoke VPC preferred path.",
      "Value":{
        "Ref":"PreferredPathTag"
      }
    }
  }
}